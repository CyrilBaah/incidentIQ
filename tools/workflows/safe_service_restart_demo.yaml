name: safe_service_restart_demo
description: Safe service restart without complex metrics validation (for demo)
risk_level: low
auto_approve: true
estimated_duration_seconds: 60
requires_kubernetes: true

inputs:
  - name: service
    type: string
    required: true
    description: Service name to restart
  
  - name: namespace
    type: string
    required: false
    default: "default"
    description: Kubernetes namespace

  - name: timeout_seconds
    type: integer
    required: false
    default: 120
    description: Max time to wait for restart

pre_checks:
  - name: verify_service_exists
    type: kubernetes
    action: get_deployment
    parameters:
      name: "${service}"
      namespace: "${namespace}"
    expected: exists
    on_failure: abort
  
  - name: check_current_health
    type: kubernetes
    action: check_pod_health
    parameters:
      deployment: "${service}"
      namespace: "${namespace}"
    expected: ready_count > 0
    on_failure: abort

steps:
  - name: rollout_restart
    type: kubernetes
    action: rollout_restart
    parameters:
      deployment: "${service}"
      namespace: "${namespace}"
    on_failure: rollback
    timeout_seconds: 120
  
  - name: wait_for_ready
    type: kubernetes
    action: wait_for_deployment_ready
    parameters:
      deployment: "${service}"
      namespace: "${namespace}"
      timeout: "${timeout_seconds}"
    on_failure: rollback
  
  - name: verify_health
    type: kubernetes
    action: check_pod_health
    parameters:
      deployment: "${service}"
      namespace: "${namespace}"
    retry_attempts: 3
    retry_delay_seconds: 5
    on_failure: rollback
  
  - name: update_incident_status
    type: internal
    action: update_incident
    parameters:
      status: "remediation_complete"
      message: "Service restarted successfully"

rollback:
  - name: alert_failure
    type: slack
    action: post_message
    parameters:
      channel: "#incidents"
      message: "⚠️ Rollback initiated for ${service} restart"
  
  - name: rollback_deployment
    type: kubernetes
    action: rollout_undo
    parameters:
      deployment: "${service}"
      namespace: "${namespace}"
  
  - name: notify_oncall
    type: slack
    action: post_message
    parameters:
      channel: "#incidents"
      message: "❌ ${service} restart failed, manual intervention required"

success_actions:
  - name: notify_success
    type: slack
    action: post_message
    parameters:
      channel: "#incidents"
      message: "✅ ${service} restarted successfully in ${namespace} namespace"
  
  - name: update_final_status
    type: internal
    action: update_incident
    parameters:
      status: "resolved"
      auto_resolved: true
      resolution_time_seconds: "${execution_time}"